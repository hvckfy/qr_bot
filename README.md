# QR Receipt Bot

## Обзор Проекта

QR Receipt Bot — это Telegram-бот, предназначенный для автоматизированной обработки чеков с QR-кодами. Бот интегрируется с системами лояльности двух условных торговых сетей: "ПравдаКофе" (кофейни) и "ХС" (магазины одежды), предоставляя пользователям бонусы или промокоды в зависимости от места совершения покупки.

Основная цель бота — упростить процесс взаимодействия пользователей с программами лояльности, автоматизируя распознавание чеков и начисление вознаграждений.

## Функциональные Возможности

*   **Выбор типа покупки:** Пользователь может выбрать, где была совершена покупка — в "ПравдаКофе" или "ХС".
*   **Обработка чеков:** Прием и анализ фотографий чеков с QR-кодами.
*   **Распознавание QR-кодов:** Использование компьютерного зрения для извлечения данных из QR-кодов.
*   **Валидация QR-кодов:** Проверка подлинности и соответствия QR-кодов заданным критериям для каждого типа магазина.
*   **Проверка на дубликаты:** Предотвращение повторного использования одного и того же QR-кода (настраивается для каждого типа покупки).
*   **Интеграция с программами лояльности:**
    *   Для покупок в **"ПравдаКофе"**: Генерация и выдача промокода на скидку 15% для магазина "ХС".
    *   Для покупок в **"ХС"**: Начисление бонусов на карту лояльности "ПравдаКофе" (с запросом номера телефона пользователя).
*   **Логирование:** Подробное логирование всех операций для мониторинга и отладки.
*   **Модульная архитектура:** Четкое разделение логики на компоненты для легкой расширяемости и поддержки.

## Используемые Технологии

*   **Python 3.10+:** Основной язык разработки.
*   **`pyTelegramBotAPI`:** Библиотека для взаимодействия с Telegram Bot API.
*   **`OpenCV`:** Библиотека для компьютерного зрения, используемая для обработки изображений.
*   **`pyzbar`:** Библиотека для декодирования штрих-кодов и QR-кодов.
*   **`numpy`:** Библиотека для численных операций, необходимая для `OpenCV`.
*   **`systemd`:** Для управления сервисом бота на сервере (автозапуск, перезапуск, логирование).

## Структура Проекта

Проект организован в модульную структуру для обеспечения чистоты кода и легкой поддержки:

```
qr-receipt-bot/
├── bot.py                          # Главный файл бота, инициализация и обработка сообщений Telegram.
├── config.py                       # Файл конфигурации с настройками бота, токенами, сообщениями и флагами.
├── README.md                       # Данный файл документации.
├── DEPLOYMENT.md                   # Подробный гайд по развертыванию бота на сервере.
├── requirements.txt                # Список Python-зависимостей проекта.
├── bot.log                         # Файл для записи логов работы бота (если логирование включено).
├── qr_history_pravdakofe.txt       # Файл истории использованных QR-кодов для "ПравдаКофе".
├── qr_history_hs.txt               # Файл истории использованных QR-кодов для "ХС".
├── registration_history_pravdakofe.txt # Файл истории регистраций в программе лояльности "ПравдаКофе".
│
├── core/                           # Модули ядра системы, отвечающие за основную логику.
│   ├── __init__.py
│   ├── main_processor.py           # Координирует весь процесс обработки чека: обнаружение, валидация, действие.
│   ├── qr_detector.py              # Отвечает за обнаружение и декодирование QR-кодов на изображении.
│   └── qr_history_manager.py       # Управляет записью и проверкой истории использованных QR-кодов.
│
└── services/                       # Модули, симулирующие взаимодействие с внешними API или реализующие внутренние сервисы.
    ├── __init__.py
    ├── pk_api/                     # Симуляция API системы лояльности "ПравдаКофе".
    │   ├── __init__.py
    │   └── loyalty.py              # Функции для симуляции регистрации и начисления бонусов.
    │
    ├── promocode_generation/       # Модули для генерации промокодов "ХС".
    │   ├── __init__.py
    │   ├── external.py             # Симуляция генерации промокода через внешний API.
    │   └── internal.py             # Внутренняя логика генерации промокода.
    │
    └── qr_validation/              # Модули для валидации QR-кодов.
        ├── __init__.py
        ├── hs/                     # Валидация QR-кодов для "ХС".
        │   ├── __init__.py
        │   ├── external.py         # Симуляция внешней валидации для "ХС".
        │   └── internal.py         # Внутренняя логика валидации для "ХС".
        │
        └── pc/                     # Валидация QR-кодов для "ПравдаКофе".
            ├── __init__.py
            ├── external.py         # Симуляция внешней валидации для "ПравдаКофе".
            └── internal.py         # Внутренняя логика валидации для "ПравдаКофе".
```

## Установка и Запуск

Для подробных инструкций по установке и развертыванию бота на сервере, включая настройку `systemd` и решение распространенных проблем с зависимостями, пожалуйста, обратитесь к файлу [DEPLOYMENT.md](DEPLOYMENT.md).

Краткие шаги:
1.  Клонируйте репозиторий.
2.  Установите Python 3.10 и системные зависимости.
3.  Создайте виртуальное окружение и установите Python-зависимости (`pip install -r requirements.txt`).
4.  Настройте `config.py` (особенно `BOT_TOKEN`).
5.  Запустите бота (рекомендуется через `systemd`).

## Конфигурация

Все основные параметры бота настраиваются в файле `config.py`. Этот файл содержит:
*   **`BOT_TOKEN`**: Токен Telegram-бота.
*   **`ENABLE_LOGGING`**: Включение/отключение логирования.
*   **`LOG_FILE_PATH`**: Путь к файлу логов.
*   **Настройки валидации QR-кодов**: Ключевые слова и флаги использования внешних API.
*   **Настройки проверки дубликатов QR-кодов**: Флаги `CHECK_DUPLICATE_QR_PRAVDAKOFE` и `CHECK_DUPLICATE_QR_HS`, а также пути к файлам истории.
*   **Настройки генерации промокодов**: Флаги использования внешних API или фиксированных промокодов.
*   **Сообщения бота**: Все текстовые сообщения, отправляемые пользователю.
*   **URL API лояльности**: Адрес симулированного API "ПравдаКофе".

Подробное описание каждой настройки доступно в файле [config.md](config.md).

## Логирование

Бот использует стандартный модуль `logging` Python. При включенном `ENABLE_LOGGING` (в `config.py`), логи записываются в файл, указанный в `LOG_FILE_PATH`, и выводятся в консоль. Это критически важно для отладки и мониторинга работы бота.

## Обработка Ошибок

Бот включает базовую обработку исключений для операций с файлами, сетевых запросов (симулированных) и обработки изображений. Все критические ошибки логируются.

## Взаимодействие с API (Симуляция)

Проект включает симуляции взаимодействия с внешними API для демонстрационных целей:
*   **`services/pk_api/loyalty.py`**: Симулирует регистрацию пользователей и начисление бонусов в системе лояльности "ПравдаКофе".
*   **`services/promocode_generation/external.py`**: Симулирует генерацию промокодов "ХС" через внешний сервис.
*   **`services/qr_validation/pc/external.py` и `services/qr_validation/hs/external.py`**: Симулируют внешнюю валидацию QR-кодов.

Эти модули могут быть заменены на реальные реализации при интеграции с настоящими внешними сервисами.

## Разработка и Расширение

Благодаря модульной структуре, проект легко расширяется:
*   **Добавление новых магазинов:** Создайте новые модули валидации QR-кодов и логики действий в `services/qr_validation/` и `core/main_processor.py`.
*   **Интеграция с реальными API:** Замените симулированные сервисы в `services/` на реальные HTTP-запросы к внешним системам.
*   **Улучшение распознавания QR:** Модуль `core/qr_detector.py` может быть улучшен для более надежного распознавания в сложных условиях.

